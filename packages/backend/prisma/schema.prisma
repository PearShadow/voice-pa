// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  supabaseId    String?   @unique
  subscription  Subscription @default(FREE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  meetings      Meeting[]
  settings      UserSettings?
  
  @@index([email])
  @@index([supabaseId])
}

model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  defaultLanguage   String   @default("en")
  autoSync          Boolean  @default(true)
  notifications     Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Meeting {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  date          DateTime @default(now())
  duration      Float    // in seconds
  platform      Platform
  audioUrl      String?
  status        MeetingStatus @default(RECORDING)
  
  transcript    Transcript?
  participants  Participant[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([date])
  @@index([status])
}

model Transcript {
  id            String   @id @default(cuid())
  meetingId     String   @unique
  meeting       Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  text          String   @db.Text
  language      String
  confidence    Float
  
  segments      TranscriptSegment[]
  speakers      Speaker[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([meetingId])
}

model TranscriptSegment {
  id            String   @id @default(cuid())
  transcriptId  String
  transcript    Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  
  speakerId     String?
  speaker       Speaker?  @relation(fields: [speakerId], references: [id])
  
  text          String   @db.Text
  startTime     Float
  endTime       Float
  confidence    Float
  
  createdAt     DateTime @default(now())
  
  @@index([transcriptId])
  @@index([speakerId])
}

model Speaker {
  id            String   @id @default(cuid())
  transcriptId  String
  transcript    Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  
  name          String?
  identifier    String   // e.g., "speaker_0", "speaker_1"
  
  segments      TranscriptSegment[]
  
  createdAt     DateTime @default(now())
  
  @@index([transcriptId])
}

model Participant {
  id            String   @id @default(cuid())
  meetingId     String
  meeting       Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  name          String
  email         String?
  
  createdAt     DateTime @default(now())
  
  @@index([meetingId])
}

enum Platform {
  MOBILE
  MEET
  ZOOM
  WHATSAPP
  PHONE
}

enum MeetingStatus {
  RECORDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Subscription {
  FREE
  PRO
  ENTERPRISE
}
